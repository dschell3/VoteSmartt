{% extends "base.html" %}

{% block title %}Event List - VoteSmart{% endblock %}

{% block content %}
<main class="max-w-7xl mx-auto px-6 py-12">
    <style>
        /* Small pulse animation for timer dot */
        @keyframes pulse-slow {
            0% {
                transform: scale(1);
                opacity: 0.9
            }

            50% {
                transform: scale(1.35);
                opacity: 0.6
            }

            100% {
                transform: scale(1);
                opacity: 0.9
            }
        }

        .timer-dot {
            animation: pulse-slow 2s ease-in-out infinite;
            box-shadow: 0 0 6px rgba(99, 102, 241, 0.18);
        }
    </style>
    <!-- Header / Hero -->
    <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-6 mb-8">
        <div>
            <h1 class="text-3xl md:text-4xl font-extrabold text-slate-900">Events Dashboard</h1>
            <p class="mt-2 text-sm text-slate-600">Manage your events — create, edit, or remove events and track
                schedules. only for admins</p>
        </div>

        <div class="flex items-center gap-3">
            <a href="/admin2"
                class="inline-flex items-center gap-2 px-4 py-2 rounded-lg bg-blue-700 hover:bg-blue-800 text-white font-medium">Create
                Event</a>
        </div>
    </div>

    <!-- Toolbar: search / filters (polished) -->
    <div class="bg-white border border-slate-100 rounded-lg p-4 shadow-sm mb-8">
        <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-4">
            <div class="flex-1 flex items-center gap-4">
                <label for="search" class="sr-only">Search events</label>
                <div class="relative w-full md:w-2/3 lg:w-1/2">
                    <input id="search" name="search" type="search" placeholder="Search events by title or description"
                        class="w-full border border-slate-200 rounded-lg py-3 pl-12 pr-4 text-sm shadow-sm focus:ring-2 focus:ring-indigo-500 focus:border-transparent transition">
                    <div class="absolute left-4 top-1/2 -translate-y-1/2 text-slate-400">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24"
                            stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M21 21l-4.35-4.35M10.5 18a7.5 7.5 0 1 1 0-15 7.5 7.5 0 0 1 0 15z" />
                        </svg>
                    </div>
                </div>

                <!-- Wider, modern select -->
                <div class="w-48">
                    <select id="filter"
                        class="w-full border border-slate-200 rounded-lg py-3 px-3 bg-white text-sm shadow-sm">
                        <option value="all">All Events</option>
                        <option value="upcoming">Upcoming</option>
                        <option value="past">Past</option>
                    </select>
                </div>
            </div>

        </div>
        <!-- Subtle metadata row -->
        <div class="mt-3 text-sm text-slate-500">Showing <strong id="events-count">{{ allEvents|length if allEvents else 0 }}</strong>
            events · Sorted by start date</div>
    </div>

    <!-- Events grid -->
    {% if allEvents %}
    <div id="eventsGrid" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6">
        {% for events in allEvents %}
        <article class="bg-white rounded-2xl p-5 shadow-md hover:shadow-lg transition-shadow relative overflow-hidden"
            data-status="{{ events.status|lower }}">
            <a href="/event/{{ events.event_id }}" class="absolute inset-0 z-10"
                aria-label="Open {{ events.title }}"></a>
            <div class="relative z-20 flex items-start justify-between gap-4">
                <div>

                   <a href="/event/{{ events.event_id }}"><h3 class="text-lg font-semibold text-slate-900"> {{ events.title }}</h3></a> 
                    {% if events.creator_full_name %}
                    <p class="mt-1 text-xs text-slate-500">
                        <span class="inline-flex items-center gap-1">
                            <svg class="w-3 h-3" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg">
                                <path fill-rule="evenodd" d="M10 9a3 3 0 100-6 3 3 0 000 6zm-7 9a7 7 0 1114 0H3z" clip-rule="evenodd"></path>
                            </svg>
                            Created by {{ events.creator_full_name }}
                        </span>
                    </p>
                    {% endif %}
                    <p class="mt-2 text-sm text-slate-600 line-clamp-3">{{ events.description }}</p>
                </div>
                <div class="shrink-0 text-right">
                    <div class="mt-2 text-right">
                        <span class="inline-flex items-center gap-2 text-xs font-medium text-indigo-600">
                            <span class="timer-dot w-2 h-2 rounded-full bg-indigo-500/90"></span>
                            <span class="event-timer" data-start="{{ events.start_time or '' }}">&mdash;</span>
                        </span>
                    </div>
                    <div class="mt-1 text-right">
                        <span class="inline-flex items-center gap-2 text-xs text-slate-500">
                            <span class="timer-dot w-2 h-2 rounded-full bg-slate-400/80"></span>
                            <span class="event-end-timer" data-end="{{ events.end_time or '' }}">&mdash;</span>
                        </span>
                    </div>
                    <!-- Status badge (Waiting / Open / Closed) -->
                    <div class="mt-3 text-right">
                        <span
                            class="event-status status-badge {% if events.status %}status-{{ events.status|lower }}{% endif %}"
                            data-start="{{ events.start_time or '' }}" data-end="{{ events.end_time or '' }}">{{
                            events.status or '—' }}</span>
                    </div>
                </div>
            </div>

            <div class="mt-4 flex items-center justify-between z-20 relative">
                <div class="flex items-center gap-2 event-actions opacity-90">
                    <a href="/event/{{ events.event_id }}" class="text-sm text-blue-600 hover:underline">View</a>
                    <!-- Only show Edit/Delete buttons if user is the creator or admin -->
                    {% if session.user_id == events.created_byFK or session.isAdminByID == 1 %}
                    <a href="/events/{{ events.event_id }}/edit"
                        class="text-sm text-slate-600 hover:text-slate-800">Edit</a>
                    <button type="button" 
                            class="text-sm text-red-600 hover:underline delete-event-btn"
                            data-event-id="{{ events.event_id }}"
                            data-event-title="{{ events.title }}"
                            data-creator-name="{{ events.creator_full_name }}">
                        Delete
                    </button>
                    {% endif %}
                </div>
            </div>
            <!-- subtle overlay to show clickable card on hover -->
            <div
                class="absolute inset-0 z-0 pointer-events-none bg-gradient-to-b from-transparent to-white/40 opacity-0 hover:opacity-100 transition-opacity">
            </div>
        </article>
        {% endfor %}
    </div>
    {% else %}

    <!-- Empty state -->
    <div class="bg-white border border-dashed border-slate-200 rounded-lg p-12 text-center">
        <svg xmlns="http://www.w3.org/2000/svg" class="mx-auto h-12 w-12 text-slate-400" fill="none" viewBox="0 0 24 24"
            stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3" />
        </svg>
        <h3 class="mt-4 text-xl font-semibold text-slate-900">No events yet</h3>
        <p class="mt-2 text-sm text-slate-600">You don't have any events. Create your first event to get started.</p>
        <div class="mt-6">
            <a href="/admin2"
                class="inline-flex items-center gap-2 px-4 py-2 rounded-lg bg-blue-700 hover:bg-blue-800 text-white font-medium">Create
                Event</a>
        </div>
    </div>
    {% endif %}
</main>
<!-- Delete Confirmation Modal -->
<div id="delete-confirm-modal" class="fixed inset-0 hidden items-center justify-center" style="z-index:20050;">
    <div class="absolute inset-0 bg-black/50" id="delete-modal-overlay"></div>
    <div class="relative bg-white rounded-lg shadow-2xl w-full max-w-lg mx-4">
        <div class="p-6">
            <h3 id="delete-modal-title" class="text-lg font-semibold text-slate-900">Delete event</h3>
            <p id="delete-modal-message" class="mt-3 text-sm text-slate-600">Are you sure you want to delete this event?</p>

            <div class="mt-6 flex justify-end gap-3">
                <button id="delete-modal-cancel" class="px-4 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300">Cancel</button>
                <button id="delete-modal-confirm" class="px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700">Delete Event</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<!-- Day.js for nice date formatting (with relative time & parsing) -->
<script src="https://cdn.jsdelivr.net/npm/dayjs@1.11.9/dayjs.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/dayjs@1.11.9/plugin/customParseFormat.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/dayjs@1.11.9/plugin/relativeTime.min.js"></script>
<script src="{{ url_for('static', filename='js/time-utils.js') }}"></script>
<script>
    // Enable Day.js plugins
    dayjs.extend(dayjs_plugin_customParseFormat);
    dayjs.extend(dayjs_plugin_relativeTime);

    function tryParse(raw) {
        return (window.TimeUtils && TimeUtils.tryParse) ? TimeUtils.tryParse(raw) : null;
    }

    function formatSingle(raw) {
        return (window.TimeUtils && TimeUtils.formatSingle) ? TimeUtils.formatSingle(raw) : '—';
    }

    function formatEventTimes() {
        document.querySelectorAll('.event-start').forEach(el => {
            const raw = el.getAttribute('data-start') || '';
            el.textContent = formatSingle(raw);
        });

        document.querySelectorAll('.event-end').forEach(el => {
            const raw = el.getAttribute('data-end') || '';
            el.textContent = formatSingle(raw);
        });
    }

    document.addEventListener('DOMContentLoaded', formatEventTimes);
</script>
<!-- Choices.js for enhanced select dropdown -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/choices.js/public/assets/styles/choices.min.css" />
<script src="https://cdn.jsdelivr.net/npm/choices.js/public/assets/scripts/choices.min.js"></script>
<style>
    /* Choices.js subtle sizing override to avoid squished dropdown */
    .choices__inner {
        padding: 0.5rem 0.75rem;
        min-height: 46px;
    }

    .choices__list--single {
        line-height: 1.25;
    }

    .choices__item--selectable {
        padding: 0 0;
    }

    .choices__list--dropdown {
        border-radius: 0.5rem;
        box-shadow: 0 8px 20px rgba(2, 6, 23, 0.08);
    }

    /* Ensure the filter dropdown (Choices.js) appears above other page elements
       so it is clickable and doesn't get blocked by cards/overlays. */
    .choices {
        position: relative;
        z-index: 20000;
    }

    .choices__inner {
        position: relative;
        z-index: 20000;
    }

    .choices__list--dropdown {
        z-index: 20010 !important;
    }

    /* Event card action polish */
    .event-actions a,
    .event-actions button {
        font-size: 0.95rem;
        padding: 0.35rem 0.5rem;
        border-radius: 0.375rem;
    }

    .event-card-meta {
        min-width: 10rem;
    }

    /* Status badge styles */
    .status-badge {
        display: inline-block;
        padding: 0.25rem 0.5rem;
        border-radius: 9999px;
        font-size: 0.75rem;
        font-weight: 600;
    }

    .status-waiting {
        background: rgba(99, 102, 241, 0.08);
        color: #6366F1;
    }

    .status-open {
        background: rgba(34, 197, 94, 0.12);
        color: #16A34A;
    }

    .status-closed {
        background: rgba(248, 113, 113, 0.12);
        color: #EF4444;
    }
</style>

<script>
    // Initialize Choices for the filter select with nicer spacing
    document.addEventListener('DOMContentLoaded', function () {
        try {
            const filter = document.getElementById('filter');
            if (filter) {
                new Choices(filter, {
                    searchEnabled: false,
                    itemSelectText: '',
                    shouldSort: false,
                    position: 'bottom',
                    classNames: {
                        containerInner: 'choices__inner',
                        listSingle: 'choices__list--single',
                        inputCloned: 'choices__input--cloned'
                    }
                });
            }
        } catch (e) {
            console.warn('Choices init failed', e);
        }

        // Start timers after formatting dates
        startEventTimers();
        // Also update statuses on initial render
        updateEventStatuses();
        // Remove events that have been closed for more than 24 hours
        removeOldClosedEvents();
        // Wire up search + filter behavior
        setupFilters();
    });

    // Hide event cards that ended more than 24 hours ago and mark them so filters won't resurrect them
    function removeOldClosedEvents() {
        try {
            const cards = Array.from(document.querySelectorAll('#eventsGrid > article'));
            const now = dayjs();
            const cutoffMs = 24 * 60 * 60 * 1000; // 24 hours in ms
            let hiddenCount = 0;

            cards.forEach(card => {
                // Prefer data-end on event-status then event-end-timer
                const statusEl = card.querySelector('.event-status');
                const endRaw = (statusEl && statusEl.getAttribute('data-end')) || (card.querySelector('.event-end-timer') && card.querySelector('.event-end-timer').getAttribute('data-end')) || '';
                if (!endRaw) return;

                const parsed = tryParse(endRaw) || (dayjs(endRaw).isValid() ? dayjs(endRaw) : null);
                if (!parsed) return;

                const diff = now.diff(parsed);
                if (diff > cutoffMs) {
                    // hide the card and mark it so filters won't bring it back
                    card.style.display = 'none';
                    card.dataset.hiddenOld = '1';
                    hiddenCount++;
                }
            });

            // Update visible count shown in header
            const countEl = document.getElementById('events-count');
            if (countEl) {
                const total = parseInt(countEl.textContent || '0', 10);
                const visible = Math.max(0, total - hiddenCount);
                countEl.textContent = visible;
            }
        } catch (e) {
            console.warn('Failed to remove old closed events', e);
        }
    }

    function humanDuration(ms) {
        return (window.TimeUtils && TimeUtils.humanDuration) ? TimeUtils.humanDuration(ms) : `${Math.floor(ms/1000)}s`;
    }

    function startEventTimers() {
        const startTimers = Array.from(document.querySelectorAll('.event-timer'));
        const endTimers = Array.from(document.querySelectorAll('.event-end-timer'));
        if (!startTimers.length && !endTimers.length) return;

        function tick() {
            const now = dayjs();
            // Start timers
            startTimers.forEach(el => {
                const startRaw = el.getAttribute('data-start') || '';
                const start = tryParse(startRaw);
                if (!start) { el.textContent = '—'; return; }
                const diff = start.diff(now);
                el.textContent = diff > 0 ? `Starts in ${humanDuration(diff)}` : `Started ${humanDuration(-diff)} ago`;
            });

            // End timers
            endTimers.forEach(el => {
                const endRaw = el.getAttribute('data-end') || '';
                const end = tryParse(endRaw);
                if (!end) { el.textContent = '—'; return; }
                const diffEnd = end.diff(now);
                el.textContent = diffEnd > 0 ? `Ends in ${humanDuration(diffEnd)}` : `Ended ${humanDuration(-diffEnd)} ago`;
            });

            // Update statuses each tick as well
            updateEventStatuses();
        }

        tick();
        setInterval(tick, 1000);
    }

    // Compute and update event status badges
    function updateEventStatuses() {
        const now = dayjs();
        document.querySelectorAll('.event-status').forEach(el => {
            const startRaw = el.getAttribute('data-start') || '';
            const endRaw = el.getAttribute('data-end') || '';
            const start = tryParse(startRaw);
            const end = tryParse(endRaw);

            // Default when dates invalid
            if (!start && !end) {
                el.textContent = 'Unknown';
                el.className = 'event-status status-badge';
                return;
            }

            // Determine status
            let status = 'Waiting';
            if (start && end) {
                if (now.isBefore(start)) status = 'Waiting';
                else if (now.isAfter(end)) status = 'Closed';
                else status = 'Open';
            } else if (start && !end) {
                status = now.isBefore(start) ? 'Waiting' : 'Open';
            } else if (!start && end) {
                status = now.isAfter(end) ? 'Closed' : 'Open';
            }

            // Apply classes
            el.textContent = status;
            el.classList.remove('status-waiting', 'status-open', 'status-closed');
            if (status === 'Waiting') el.classList.add('status-waiting');
            if (status === 'Open') el.classList.add('status-open');
            if (status === 'Closed') el.classList.add('status-closed');
        });
    }

    // Client-side filtering
    function setupFilters() {
        const searchInput = document.getElementById('search');
        const filterSelect = document.getElementById('filter');
        const grid = document.getElementById('eventsGrid');
        if (!grid) return;

        function applyFilters() {
            const q = searchInput ? searchInput.value.trim().toLowerCase() : '';
            const status = filterSelect ? (filterSelect.value || 'all') : 'all';

            Array.from(grid.children).forEach(card => {
                // If the card was marked hiddenOld, allow it to be shown when the 'past' filter is active.
                if (card.dataset && card.dataset.hiddenOld === '1' && status !== 'past') {
                    card.style.display = 'none';
                    return;
                }
                const title = (card.querySelector('h3') || { textContent: '' }).textContent.toLowerCase();
                const desc = (card.querySelector('p') || { textContent: '' }).textContent.toLowerCase();
                const cardStatus = card.getAttribute('data-status') || 'unknown';

                const matchesQuery = q === '' || title.includes(q) || desc.includes(q);
                const matchesStatus = status === 'all' || (status === 'upcoming' && cardStatus === 'waiting') || (status === 'past' && cardStatus === 'closed') || (status === 'open' && cardStatus === 'open');

                if (matchesQuery && matchesStatus) {
                    card.style.display = '';
                } else {
                    card.style.display = 'none';
                }
            });

            // Update visible count shown in header after filtering
            try {
                const countEl = document.getElementById('events-count');
                if (countEl) {
                    const visible = Array.from(grid.children).filter(c => c.style.display !== 'none').length;
                    countEl.textContent = visible;
                }
            } catch (e) {
                console.warn('Failed to update events count after filtering', e);
            }
        }

        let debounceTimer;
        function debounceApply() {
            clearTimeout(debounceTimer);
            debounceTimer = setTimeout(applyFilters, 150);
        }

        if (searchInput) searchInput.addEventListener('input', debounceApply);
        if (filterSelect) filterSelect.addEventListener('change', applyFilters);
    }

    // Delete event confirmation (custom modal to replace native confirm)
    function setupDeleteConfirmation() {
        const deleteButtons = document.querySelectorAll('.delete-event-btn');
        const modal = document.getElementById('delete-confirm-modal');
        const overlay = document.getElementById('delete-modal-overlay');
        const titleEl = document.getElementById('delete-modal-title');
        const msgEl = document.getElementById('delete-modal-message');
        const cancelBtn = document.getElementById('delete-modal-cancel');
        const confirmBtn = document.getElementById('delete-modal-confirm');
        let currentEventId = null;

        function openModal(eventId, eventTitle, creatorName) {
            currentEventId = eventId;
            titleEl.textContent = `Delete \"${eventTitle}\"?`;
            msgEl.textContent = `Created by: ${creatorName || '—'}\n\nThis action cannot be undone.`;
            console.log('[DELETE MODAL] openModal for', eventId, eventTitle);
            // Show modal and center it
            modal.classList.remove('hidden');
            modal.classList.add('flex');
            // Blur active element to close any open dropdowns (Choices.js)
            try { if (document.activeElement) document.activeElement.blur(); } catch (e) {}
            // Prevent background scroll while modal open
            document.body.style.overflow = 'hidden';
            // Focus the cancel button for accessibility
            try { cancelBtn.focus(); } catch (e) {}
        }

        function closeModal() {
            modal.classList.add('hidden');
            modal.classList.remove('flex');
            currentEventId = null;
            document.body.style.overflow = '';
        }

        deleteButtons.forEach(button => {
            button.addEventListener('click', function(e) {
                e.preventDefault();
                const eventId = this.getAttribute('data-event-id');
                const eventTitle = this.getAttribute('data-event-title') || 'Event';
                const creatorName = this.getAttribute('data-creator-name') || '';
                openModal(eventId, eventTitle, creatorName);
            });
        });

        // Cancel / overlay handlers
        cancelBtn.addEventListener('click', closeModal);
        overlay.addEventListener('click', closeModal);

        // Close on Escape
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape' && modal && !modal.classList.contains('hidden')) {
                closeModal();
            }
        });

        // Confirm -> use fetch POST so we can capture server responses and show errors
        confirmBtn.addEventListener('click', async function() {
            console.log('[DELETE MODAL] confirm clicked, eventId=', currentEventId);
            if (!currentEventId) { console.warn('[DELETE MODAL] no currentEventId set'); return closeModal(); }

            // UI feedback
            confirmBtn.disabled = true;
            const origText = confirmBtn.textContent;
            confirmBtn.textContent = 'Deleting...';

            try {
                const csrfMeta = document.querySelector('meta[name="csrf-token"]');
                const headers = { 'Content-Type': 'application/x-www-form-urlencoded' };
                let body = '';
                if (csrfMeta) {
                    body = `csrf_token=${encodeURIComponent(csrfMeta.getAttribute('content'))}`;
                    console.log('[DELETE MODAL] using CSRF token from meta');
                }

                const resp = await fetch(`/events/${currentEventId}/delete`, {
                    method: 'POST',
                    headers,
                    body,
                    credentials: 'same-origin',
                    redirect: 'follow'
                });

                console.log('[DELETE MODAL] fetch response:', resp.status, resp.redirected, resp.url);

                if (resp.redirected) {
                    // follow server redirect (login or event list)
                    window.location.href = resp.url;
                    return;
                }

                if (resp.ok) {
                    // success - reload to reflect deletion
                    window.location.reload();
                    return;
                }

                // Non-OK response: show server message in modal if available
                let text = '';
                try { text = await resp.text(); } catch (e) { text = `Status ${resp.status}`; }
                msgEl.textContent = `Delete failed: ${text}`;
                console.warn('[DELETE MODAL] delete failed:', resp.status, text);
            } catch (err) {
                console.error('[DELETE MODAL] fetch delete error', err);
                msgEl.textContent = 'An unexpected error occurred while attempting to delete. Check the console for details.';
            } finally {
                confirmBtn.disabled = false;
                confirmBtn.textContent = origText;
            }
        });
    }

    // Initialize the delete modal wiring when DOM is ready
    document.addEventListener('DOMContentLoaded', function() {
        setupDeleteConfirmation();
    });
</script>
{% endblock %}