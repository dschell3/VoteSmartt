{% extends "base.html" %}

{% block title %}Reset Password - VoteSmart{% endblock %}

{% block content %}
<main class="max-w-lg mx-auto px-6 py-12">
  <div class="bg-white rounded-2xl p-8 shadow">
    <h1 class="text-2xl font-bold mb-4">Set New Password</h1>
    <p class="text-sm text-slate-600 mb-6">Set the new password for your account so you can login and access all features.</p>

    <form action="{{ url_for('reset_password_submit') }}" method="post" class="space-y-4">
      <input type="hidden" name="token" value="{{ token }}" />
      <div>
        <label class="block text-sm font-medium text-slate-700 mb-2">Enter new password</label>
        <div class="relative">
          <input id="resetNewPassword" type="password" name="new_password" required class="w-full px-4 py-3 pr-12 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" />
          <button type="button" class="password-eye-btn" onclick="togglePassword('resetNewPassword')">
            <svg class="w-5 h-5 eye-closed" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M17.94 17.94A10.07 10.07 0 0 1 12 20c-7 0-11-8-11-8a18.45 18.45 0 0 1 5.06-5.94M9.9 4.24A9.12 9.12 0 0 1 12 4c7 0 11 8 11 8a18.5 18.5 0 0 1-2.16 3.19m-6.72-1.07a3 3 0 1 1-4.24-4.24"/>
              <line x1="1" y1="1" x2="23" y2="23"/>
            </svg>
            <svg class="w-5 h-5 eye-open" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="display: none;">
              <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/>
              <circle cx="12" cy="12" r="3"/>
            </svg>
          </button>
        </div>
      </div>
      <div>
        <label class="block text-sm font-medium text-slate-700 mb-2">Confirm password</label>
        <div class="relative">
          <input id="resetConfirmPassword" type="password" name="confirm_password" required class="w-full px-4 py-3 pr-12 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" />
          <button type="button" class="password-eye-btn" onclick="togglePassword('resetConfirmPassword')">
            <svg class="w-5 h-5 eye-closed" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M17.94 17.94A10.07 10.07 0 0 1 12 20c-7 0-11-8-11-8a18.45 18.45 0 0 1 5.06-5.94M9.9 4.24A9.12 9.12 0 0 1 12 4c7 0 11 8 11 8a18.5 18.5 0 0 1-2.16 3.19m-6.72-1.07a3 3 0 1 1-4.24-4.24"/>
              <line x1="1" y1="1" x2="23" y2="23"/>
            </svg>
            <svg class="w-5 h-5 eye-open" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="display: none;">
              <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/>
              <circle cx="12" cy="12" r="3"/>
            </svg>
          </button>
        </div>
      </div>
  <button type="submit" class="w-full bg-blue-600 hover:bg-blue-700 text-white py-3 rounded-lg font-semibold">Update Password</button>
    </form>
  </div>
</main>
<script>
  function togglePassword(id) {
    const input = document.getElementById(id);
    if (!input) return;
    const btn = input.parentElement.querySelector('.password-eye-btn');
    const eyeClosed = btn.querySelector('.eye-closed');
    const eyeOpen = btn.querySelector('.eye-open');
    if (input.type === 'password') {
      input.type = 'text';
      eyeClosed.style.display = 'none';
      eyeOpen.style.display = 'block';
    } else {
      input.type = 'password';
      eyeClosed.style.display = 'block';
      eyeOpen.style.display = 'none';
    }
  }
  window.addEventListener('load', function(){
    document.querySelectorAll('.password-eye-btn').forEach(btn => {
      btn.style.position = 'absolute';
      btn.style.top = '50%';
      btn.style.right = '12px';
      btn.style.transform = 'translateY(-50%)';
    });
  });
  </script>
  <script>
    // Password validation on Reset Password page
    document.addEventListener('DOMContentLoaded', function() {
  // find the reset password form (prefer the form containing the hidden token)
  let form = document.querySelector('form');
  const tokenInput = document.querySelector('input[name="token"]');
  if (tokenInput) form = tokenInput.closest('form') || form;
      const newPwd = document.getElementById('resetNewPassword');
      const confirmPwd = document.getElementById('resetConfirmPassword');
      const submitBtn = form.querySelector('button[type="submit"]');

      if (!form || !newPwd || !confirmPwd) return;

      // Show strength as user types (reuses showPasswordStrength from base.html)
      newPwd.addEventListener('input', function() {
        // Clear any previous field error while typing
        if (typeof clearFieldError === 'function') clearFieldError(newPwd);
        if (typeof showPasswordStrength === 'function') showPasswordStrength(newPwd, newPwd.value);
      });

      confirmPwd.addEventListener('input', function() {
        if (typeof clearFieldError === 'function') clearFieldError(confirmPwd);
      });

      form.addEventListener('submit', function(e) {
        // Clear previous errors
        if (typeof clearFieldError === 'function') { clearFieldError(newPwd); clearFieldError(confirmPwd); }

        let hasError = false;

        // Validate password requirements using getPasswordErrorMessage if available
        if (typeof getPasswordErrorMessage === 'function') {
          const err = getPasswordErrorMessage(newPwd.value || '');
          if (err) {
            if (typeof showFieldError === 'function') showFieldError(newPwd, err);
            else {
              // fallback: simple alert
              alert(err);
            }
            hasError = true;
          }
        }

        // Confirm match
        if (newPwd.value !== confirmPwd.value) {
          const msg = 'Passwords do not match';
          if (typeof showFieldError === 'function') showFieldError(confirmPwd, msg);
          else alert(msg);
          hasError = true;
        }

        if (hasError) {
          e.preventDefault();
          // focus first invalid field
          if (newPwd.value && newPwd.value !== confirmPwd.value) confirmPwd.focus();
          else newPwd.focus();
          return false;
        }

        // disable button to avoid duplicate submits
        submitBtn.disabled = true;
        submitBtn.textContent = 'Updating...';
      });
    });
  </script>
{% endblock %}
