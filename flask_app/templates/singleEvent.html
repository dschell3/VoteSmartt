{% extends "base.html" %}

{% block title %}{{ event.title if event else 'Event' }} - VoteSmart{% endblock %}

{% block extra_css %}
/* Single event page scoped styles */
.event-hero { background: linear-gradient(90deg,#0b3b7a 0%,#155ac2 100%); color: white; border-radius: 12px; padding: 28px; }
.event-card { background: white; border-radius: 12px; padding: 20px; box-shadow: 0 8px 30px rgba(2,6,23,0.06); }
.cta-primary { background: linear-gradient(90deg,#0b3b7a,#155ac2); color:white; padding:10px 16px; border-radius:8px; font-weight:600 }
.cta-ghost { border:1px solid rgba(11,18,32,0.12); padding:10px 14px; border-radius:8px }
.recommendation-item { transition:transform .15s ease, box-shadow .15s ease }
.recommendation-item:hover { transform:translateY(-4px); box-shadow:0 10px 30px rgba(2,6,23,0.06) }
.vote-stack { display:flex; flex-direction:column; gap:10px; }
.vote-option { display:flex; align-items:flex-start; gap:10px; padding:14px 16px; border:1px solid #e2e8f0; border-radius:10px; cursor:pointer; background:#fff; transition:border-color .15s ease, background-color .15s ease; }
.vote-option:hover { border-color:#cbd5e1; }
.vote-option--selected { background:#eef5ff; border-color:#b9d0ff; }
.winner-outline { outline:2px solid #22c55e; outline-offset:2px; border-color:#22c55e; }
.welcome-banner { margin:4px 0 22px; padding:2px 0; }
.welcome-banner h2 { font-size:1.55rem; font-weight:700; letter-spacing:.5px; color:#0b3b7a; }
/* Celebration styles for finished results */
.celebration-banner { background: linear-gradient(90deg,#06b6d4 0%,#3b82f6 100%); color: white; padding:12px 16px; border-radius:10px; display:flex; align-items:center; gap:12px; box-shadow:0 10px 30px rgba(59,130,246,0.12); }
.celebration-banner h3 { margin:0; font-size:1.125rem; font-weight:700; }
.winner-card { display:flex; gap:16px; align-items:center; padding:18px; border-radius:12px; background: linear-gradient(180deg,#ffffff 0%, #f8fafc 100%); box-shadow:0 10px 30px rgba(2,6,23,0.06); border:2px solid rgba(34,197,94,0.08); }
.winner-badge { background:linear-gradient(90deg,#10b981,#06b6d4); color:white; padding:8px 12px; border-radius:999px; font-weight:700; font-size:0.95rem; }
.winner-name { font-size:1.25rem; font-weight:800; color:#0b3b7a; }
.winner-percent { font-size:1.25rem; font-weight:900; color:#0b3b7a; }
.result-bar { height:10px; background:#e6eefc; border-radius:999px; overflow:hidden; }
.result-bar > .fill { height:100%; background:linear-gradient(90deg,#7c3aed,#6366f1); width:0%; transition:width 900ms cubic-bezier(.2,.9,.2,1); }
.small-option { display:flex; justify-content:space-between; align-items:center; gap:12px; padding:10px; border-radius:8px; background:#fff; border:1px solid #eef2ff; }
.pulse-glow { box-shadow: 0 0 0 0 rgba(34,197,94,0.35); animation: pulse 2.2s infinite; }
@keyframes pulse { 0% { box-shadow:0 0 0 0 rgba(34,197,94,0.35);} 70% { box-shadow:0 0 0 18px rgba(34,197,94,0);} 100% { box-shadow:0 0 0 0 rgba(34,197,94,0);} }
@media (min-width: 640px){ .welcome-banner h2 { font-size:1.65rem; } }
@media (min-width: 1024px) { .event-grid { display:grid; grid-template-columns: 1fr 360px; gap:28px } }
{% endblock %}

{% block content %}
<main class="max-w-6xl mx-auto px-6 py-12">
    {# Silently consume flash messages without displaying them #}
    {% with messages = get_flashed_messages(with_categories=true) %}
        {# Messages consumed but not displayed - prevents carryover to other pages #}
    {% endwith %}
    
    {% if not event %}
    <div class="event-card text-center">
        <h2 class="text-2xl font-semibold">Event not found</h2>
        <p class="mt-3 text-slate-600">The event you're looking for doesn't exist or has been removed.</p>
        <div class="mt-6"><a href="/eventList" class="cta-ghost">Back to events</a></div>
    </div>
    {% else %}

    <!-- Welcome banner OUTSIDE hero, left above blue card -->
    <div class="welcome-banner">
        <h2>Welcome {{ first_name if first_name else 'User' }}</h2>
    </div>

    <!-- Hero simplified: title / description / status left; organizer & timer right -->
    <section class="event-hero mb-8">
        <div class="flex items-start justify-between gap-6 flex-col lg:flex-row">
            <div class="flex-1">
                <h1 class="text-3xl lg:text-4xl font-extrabold">{{ event.title }}</h1>
                <p class="mt-3 text-slate-100 max-w-2xl">{{ event.description }}</p>
                <div class="mt-4 text-sm font-semibold tracking-wide">
                    <span>Status: <span id="liveStatus" class="font-normal">&mdash;</span></span>
                </div>
            </div>

            <div class="flex flex-col items-end gap-2 lg:mt-0">
                <div class="text-sm">Organized by</div>
                <div class="text-white font-semibold">{{ event.creator_full_name if event.creator_full_name else 'Unknown User' }}</div>
                <div id="timerLarge" class="text-indigo-200 font-medium mt-2">&mdash;</div>
            </div>
        </div>
    </section>

    <div class="event-grid">
        <!-- Main content -->
        <section>
            <div class="event-card">
                <h2 class="text-xl font-semibold">About this event</h2>
                <div class="mt-6">
                    <h3 class="text-sm text-slate-500 font-semibold">Details</h3>
                    <ul class="mt-3 space-y-3 text-sm text-slate-600">
                        <li><strong>Start:</strong> <span id="detailStart">&mdash;</span></li>
                        <li><strong>End:</strong> <span id="detailEnd">&mdash;</span></li>
                        <li><strong>Status:</strong> <span id="detailStatus">&mdash;</span></li>
                        <li><strong>Created at:</strong> {{ created_at_display if created_at_display is defined else (event.created_at or '—') }}</li>
                    </ul>
                </div>

            </div>

            {# Removed separate Full description block per new layout #}

            <!-- Ballot / Results -->
            <div class="mt-6 event-card" id="ballot">
                {% if is_open %}
                    <h3 class="text-lg font-semibold mb-4">Have a Pick</h3>
                    
                    {# NEW: Check if user is the event creator #}
                    {% if is_event_creator %}
                        {# Show disabled voting interface with explanation for event creators #}
                        <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-4 mb-4">
                            <div class="flex items-start gap-3">
                                <svg class="w-5 h-5 text-yellow-600 flex-shrink-0 mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
                                </svg>
                                <div>
                                    <p class="font-medium text-yellow-800">Event creators cannot vote</p>
                                    <p class="text-sm text-yellow-700 mt-1">As the creator of this event, you cannot participate in voting to maintain integrity and impartiality.</p>
                                </div>
                            </div>
                        </div>
                        
                        {% if not options %}
                            <div class="text-sm text-slate-500">No options available for voting.</div>
                        {% else %}
                            {# Show voting options in disabled state #}
                            <div class="space-y-2 opacity-60 pointer-events-none">
                                {% for o in options %}
                                <label class="flex items-start gap-3 p-3 rounded-lg border border-slate-200 bg-slate-50 cursor-not-allowed">
                                    <input type="radio" class="mt-1" name="option_id_disabled" value="{{ o.option_id }}" disabled />
                                    <div>
                                        <div class="font-medium text-slate-600">{{ o.option_text }}</div>
                                    </div>
                                </label>
                                {% endfor %}
                            </div>
                            <div class="mt-3">
                                <button type="button" class="cta-primary opacity-50 cursor-not-allowed" disabled>
                                    Submit Vote (Disabled)
                                </button>
                            </div>
                        {% endif %}
                    
                    {% else %}
                        {# Normal voting interface for non-creators #}
                        {% if not options %}
                            <div class="text-sm text-slate-500">No options available for voting.</div>
                        {% else %}
                            {# Compute the selected option text for a clearer UI when user already voted #}
                            {% set selected_text = '' %}
                            {% for o in options %}
                                {% if selected_option_id == o.option_id %}
                                    {% set selected_text = o.option_text %}
                                {% endif %}
                            {% endfor %}

                            {# Show a clear banner when the current user has already voted #}
                            {% if selected_option_id %}
                                <div class="mb-4 p-3 bg-green-50 border border-green-200 rounded-lg flex items-start gap-3" role="status" aria-live="polite">
                                    <svg class="w-5 h-5 text-green-600 mt-0.5 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
                                    </svg>
                                    <div>
                                        <div class="font-medium text-green-800">You voted</div>
                                        <div class="text-sm text-green-700">Your current vote: <span class="font-semibold">{{ selected_text }}</span></div>
                                    </div>
                                </div>
                            {% endif %}

                            <form action="/vote/cast" method="post" class="space-y-3">
                                <input type="hidden" name="event_id" value="{{ event.event_id }}" />
                                <div class="vote-stack">
                                    {% for o in options %}
                                    <label class="vote-option {{ 'vote-option--selected' if selected_option_id==o.option_id else '' }}">
                                        <input type="radio" class="mt-1" name="option_id" value="{{ o.option_id }}" {{ 'checked' if selected_option_id==o.option_id }} />
                                        <div class="font-medium text-slate-800">
                                            {{ o.option_text }}
                                            {% if selected_option_id == o.option_id %}
                                                <span class="ml-2 inline-flex items-center px-2 py-0.5 rounded-full text-xs font-medium bg-green-100 text-green-800">Your vote</span>
                                            {% endif %}
                                        </div>
                                    </label>
                                    {% endfor %}
                                </div>
                                <div class="flex items-center gap-3 pt-2">
                                    <button type="submit" class="cta-primary">{{ 'Update Vote' if selected_option_id else 'Submit Vote' }}</button>
                                    {% if selected_option_id %}
                                    <!-- Use a custom modal to confirm retracting a vote -->
                                    <button type="button"
                                            id="retract-vote-btn"
                                            class="cta-ghost"
                                            data-selected-text="{{ selected_text }}"
                                            aria-haspopup="dialog">
                                        Retract Vote
                                    </button>
                                    {% endif %}
                                </div>
                                {% if selected_option_id %}
                                <div class="text-sm text-slate-600 mt-2">You have already voted. You can update your choice or retract your vote while the event remains open.</div>
                                {% endif %}
                            </form>
                        {% endif %}
                    {% endif %}
                {% else %}
                    <h3 id="resultsHeading" class="text-lg font-semibold mb-4">Results</h3>
                    <div role="region" aria-labelledby="resultsHeading">
                        {% if not tallies %}
                            <div class="text-sm text-slate-500">No votes yet.</div>
                        {% else %}
                            {# Compute total votes for percentages using the sum filter (works with list of dicts/objects) #}
                            {% set total_votes = tallies|sum(attribute='votes') %}

                            {# Celebration banner and highlighted winner #}
                            <div class="celebration-banner mb-4" role="status" aria-live="polite">
                                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M12 8v4l3 3"/></svg>
                                <div>
                                    <h3 class="text-white">Voting finished — results are in!</h3>
                                    <div class="text-sm text-white/90">Total votes: {{ total_votes }}</div>
                                </div>
                            </div>

                            {% if total_votes > 0 and winner_option_ids %}
                                {# pick first winner for hero display (ties will show first winner) #}
                                {% set primary_winner = None %}
                                {% for t in tallies %}
                                    {% if t.option_id in winner_option_ids %}
                                        {% if not primary_winner %}
                                            {% set primary_winner = t %}
                                        {% endif %}
                                    {% endif %}
                                {% endfor %}

                                {% if primary_winner %}
                                    <div class="winner-card mb-4 pulse-glow" id="winner-card">
                                        <div class="winner-badge">Winner</div>
                                        <div>
                                            <div class="winner-name">{{ primary_winner.option_text }}</div>
                                            <div class="text-sm text-slate-600">{{ primary_winner.votes }} vote{{ 's' if primary_winner.votes != 1 }}</div>
                                        </div>
                                        <div class="ml-auto text-right">
                                            {% set pct = (primary_winner.votes * 100.0 / total_votes) if total_votes else 0 %}
                                            <div class="winner-percent">{{ (pct|round(0)|int) }}%</div>
                                            <div class="text-xs text-slate-400">of total</div>
                                        </div>
                                    </div>
                                {% endif %}
                            {% endif %}

                            {# List options with bars underneath the winner card #}
                            <div class="space-y-3">
                                {% for t in tallies %}
                                        {% set pct = (t.votes * 100.0 / total_votes) if total_votes else 0 %}
                                    <div class="small-option" role="listitem">
                                        <div>
                                            <div class="font-medium text-slate-800">{{ t.option_text }}</div>
                                            <div class="text-xs text-slate-500 mt-1">{{ t.votes }} vote{{ 's' if t.votes != 1 }}</div>
                                        </div>
                                        <div style="min-width:160px; max-width:260px; width:40%">
                                            <div class="result-bar" aria-hidden="true">
                                                <div class="fill" data-percent="{{ (pct|round(1)) }}" style="width:0%"></div>
                                            </div>
                                            <div class="text-xs text-slate-400 text-right mt-1">{{ (pct|round(0)|int) }}%</div>
                                        </div>
                                    </div>
                                {% endfor %}
                            </div>
                        {% endif %}
                    </div>
                {% endif %}
            </div>
        </section>

        <!-- Sidebar: info/support + recommendations -->
        <aside>
            <div class="event-card mb-6">
                <h3 class="text-lg font-semibold mb-3">Info & Support</h3>
                <div class="flex flex-col gap-3">
                    <a href="/contact" class="cta-ghost text-center">Contact Us</a>
                    <a href="#ballot" class="cta-ghost text-center">Voting Information</a>
                    {% if is_event_creator %}
                    <button id="user-list-btn" class="cta-ghost text-center">User List</button>
                    {% endif %}
                </div>
            </div>
            <div class="event-card">
                <h4 class="text-lg font-semibold">You might also like</h4>
                <div class="mt-3 space-y-3">
                    {% if recommendations %}
                        {% for r in recommendations %}
                        <a href="/event/{{ r.event_id }}" class="recommendation-item block p-3 rounded-lg border border-slate-100">
                            <div class="flex items-start justify-between gap-3">
                                <div class="flex-1">
                                    <div class="text-sm font-semibold text-slate-900">{{ r.title }}</div>
                                    <div class="text-xs text-slate-500 mt-1">{{ r.description[:80] }}{% if r.description|length > 80 %}...{% endif %}</div>
                                </div>
                                <div class="shrink-0 text-xs text-slate-400">{{ r.computed_status or r.status or '—' }}</div>
                            </div>
                        </a>
                        {% endfor %}
                    {% else %}
                        <div class="text-sm text-slate-500">No recommendations</div>
                    {% endif %}
                </div>
            </div>
            {% if is_open %}
            <div class="event-card mt-4" id="voting-countdown-card">
                <h4 class="text-lg font-semibold">Time left to vote</h4>
                <div class="mt-3 text-center">
                    <div id="sidebar-countdown" class="text-2xl font-bold text-indigo-600">—:—:—</div>
                    <div class="text-sm text-slate-500 mt-1">Ends <span id="sidebar-end-time">—</span></div>
                </div>
            </div>
            {% endif %}
        </aside>
    </div>

    {% endif %}
</main>
<!-- User List Modal -->
<div id="user-list-modal" class="fixed inset-0 hidden items-center justify-center z-50">
    <div class="absolute inset-0 bg-black/50" id="user-list-overlay"></div>
    <div class="relative bg-white rounded-lg shadow-2xl w-full max-w-2xl mx-4">
        <div class="p-6">
            <div class="flex items-center justify-between">
                <h3 class="text-lg font-semibold">All Users</h3>
                <button id="user-list-close" class="text-sm text-slate-600">Close</button>
            </div>
            <div id="user-list-content" class="mt-4 max-h-96 overflow-auto text-sm text-slate-700">
                <div class="text-center text-slate-400">Loading...</div>
            </div>
        </div>
    </div>
</div>
<!-- Retract Vote Modal -->
<div id="retract-modal" class="fixed inset-0 hidden items-center justify-center z-50">
    <div class="absolute inset-0 bg-black/50" id="retract-overlay"></div>
    <div class="relative bg-white rounded-lg shadow-2xl w-full max-w-lg mx-4">
        <div class="p-6">
            <div class="flex items-start justify-between">
                <div class="flex items-start gap-3">
                    <svg class="w-6 h-6 text-red-600 mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M12 2a10 10 0 1010 10A10 10 0 0012 2z"/>
                    </svg>
                    <div>
                        <h3 class="text-lg font-semibold text-red-700">Confirm retract vote</h3>
                        <p id="retract-modal-message" class="text-sm text-slate-600 mt-1">Are you sure you want to retract your vote?</p>
                    </div>
                </div>
                <button id="retract-close" class="text-sm text-slate-600">Close</button>
            </div>
            <div class="mt-6 flex justify-end gap-3">
                <button id="retract-cancel" type="button" class="px-4 py-2 bg-gray-200 text-gray-700 rounded-md hover:bg-gray-300">Cancel</button>
                <button id="retract-confirm" type="button" class="px-4 py-2 bg-red-600 text-white rounded-md hover:bg-red-700">Yes, retract my vote</button>
            </div>
        </div>
    </div>
</div>

<!-- Hidden retract form submitted by modal -->
<form id="retract-form" action="/vote/delete" method="post" style="display:none;">
    <input type="hidden" name="event_id" value="{{ event.event_id }}" />
</form>
{% endblock %}

{% block extra_js %}
    <!-- Reuse Day.js as used in other templates -->
    <script src="https://cdn.jsdelivr.net/npm/dayjs@1.11.9/dayjs.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/dayjs@1.11.9/plugin/customParseFormat.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/dayjs@1.11.9/plugin/relativeTime.min.js"></script>
    <script src="{{ url_for('static', filename='js/time-utils.js') }}"></script>
    <script src="{{ url_for('static', filename='js/vote-interactions.js') }}"></script>
    <script>
        dayjs.extend(dayjs_plugin_customParseFormat);
        dayjs.extend(dayjs_plugin_relativeTime);

        function tryParse(raw) { return (window.TimeUtils && TimeUtils.tryParse) ? TimeUtils.tryParse(raw) : null; }

        function formatDisplay(elId, raw) {
            const el = document.getElementById(elId);
            if (!el) return;
            el.textContent = (window.TimeUtils && TimeUtils.formatSingle) ? TimeUtils.formatSingle(raw) : '—';
        }

        function computeStatus(startRaw,endRaw) { return (window.TimeUtils && TimeUtils.computeStatus) ? TimeUtils.computeStatus(startRaw,endRaw) : 'Unknown'; }

        document.addEventListener('DOMContentLoaded', function(){
            const startRaw = '{{ event.start_time or "" }}';
            const endRaw = '{{ event.end_time or "" }}';
            formatDisplay('detailStart', startRaw);
            formatDisplay('detailEnd', endRaw);

            const status = computeStatus(startRaw,endRaw);
            const statusEl = document.getElementById('liveStatus');
            const detailStatus = document.getElementById('detailStatus');
            if (statusEl) statusEl.textContent = status;
            if (detailStatus) detailStatus.textContent = status;

            // Start a large timer display
            const timerEl = document.getElementById('timerLarge');
            function tick() {
                const now = dayjs();
                const start = tryParse(startRaw);
                if (!start) { if (timerEl) timerEl.textContent = '—'; return; }
                const diff = start.diff(now);
                if (diff > 0) {
                    timerEl.textContent = 'Starts in ' + humanDuration(diff);
                } else {
                    timerEl.textContent = 'Started ' + humanDuration(-diff) + ' ago';
                }
            }

            function humanDuration(ms) { return (window.TimeUtils && TimeUtils.humanDuration) ? TimeUtils.humanDuration(ms) : `${Math.floor(ms/1000)}s`; }

            tick();
            setInterval(tick,1000);

            // ===== Sidebar countdown (shows only when the countdown element exists) =====
            try {
                const sidebarEl = document.getElementById('sidebar-countdown');
                const sidebarEndEl = document.getElementById('sidebar-end-time');
                if (sidebarEndEl) {
                    const end = tryParse(endRaw);
                    sidebarEndEl.textContent = (window.TimeUtils && TimeUtils.formatSingle) ? TimeUtils.formatSingle(endRaw) : (end ? dayjs(end).format('MMM D, YYYY h:mm A') : '—');
                }

                const end = tryParse(endRaw);
                if (sidebarEl && end) {
                    function updateSidebar() {
                        const now = dayjs();
                        const diff = end.diff(now);
                        if (diff <= 0) {
                            sidebarEl.textContent = 'Voting ended';
                            clearInterval(sidebarInterval);
                            return;
                        }
                        // Use TimeUtils.humanDuration when available, otherwise fallback to HH:MM:SS
                        if (window.TimeUtils && TimeUtils.humanDuration) {
                            sidebarEl.textContent = TimeUtils.humanDuration(diff);
                        } else {
                            const s = Math.floor(diff/1000);
                            const hh = String(Math.floor(s/3600)).padStart(2,'0');
                            const mm = String(Math.floor((s%3600)/60)).padStart(2,'0');
                            const ss = String(s%60).padStart(2,'0');
                            sidebarEl.textContent = `${hh}:${mm}:${ss}`;
                        }
                    }
                    updateSidebar();
                    const sidebarInterval = setInterval(updateSidebar, 1000);
                }
            } catch (err) {
                console.warn('Sidebar countdown init failed', err);
            }

            // Set results bar widths when present
            // Removed pie-chart + bar width logic per simplified spec
        });
        // ===== Results celebration: animate bars and confetti when results present =====
        document.addEventListener('DOMContentLoaded', function(){
            try {
                // Animate result bars
                const fills = document.querySelectorAll('.result-bar .fill');
                fills.forEach(function(el, idx){
                    const pct = parseFloat(el.getAttribute('data-percent') || '0');
                    // small delay per row for pleasant stagger
                    setTimeout(()=>{ el.style.width = Math.min(100, pct) + '%'; }, idx * 120);
                });

                // If there's a winner card, fire confetti once
                const winner = document.getElementById('winner-card');
                if (winner) {
                    // load canvas-confetti from CDN and fire a couple bursts
                    (function loadConfetti(cb){
                        var s = document.createElement('script');
                        s.src = 'https://cdn.jsdelivr.net/npm/canvas-confetti@1.5.1/dist/confetti.browser.min.js';
                        s.async = true;
                        s.onload = cb;
                        s.onerror = function(){ console.warn('Confetti library failed to load'); };
                        document.head.appendChild(s);
                    })(function(){
                        try {
                            // multiple bursts
                            confetti({ particleCount: 60, spread: 50, origin: { y: 0.6 } });
                            setTimeout(()=> confetti({ particleCount: 40, spread: 60, origin: { y: 0.6 } }), 350);
                        } catch (e) { console.warn('Confetti failed', e); }
                    });
                }
            } catch (err) { console.warn('Results celebration init failed', err); }
        });
        // ===== User List modal logic (creator only) =====
        document.addEventListener('DOMContentLoaded', function(){
            const btn = document.getElementById('user-list-btn');
            const modal = document.getElementById('user-list-modal');
            const overlay = document.getElementById('user-list-overlay');
            const closeBtn = document.getElementById('user-list-close');
            const content = document.getElementById('user-list-content');
            if (!btn || !modal) return; // not creator or no modal

            async function openUserList() {
                modal.classList.remove('hidden');
                modal.classList.add('flex');
                document.body.style.overflow = 'hidden';
                content.innerHTML = '<div class="text-center text-slate-400">Loading...</div>';
                try {
                    const resp = await fetch('/users/list', { credentials: 'same-origin' });
                    if (!resp.ok) {
                        content.innerHTML = `<div class="text-red-600">Failed to load users (status ${resp.status})</div>`;
                        return;
                    }
                    const json = await resp.json();
                    if (!json.ok) {
                        content.innerHTML = `<div class="text-red-600">${json.error || 'Failed to load users'}</div>`;
                        return;
                    }
                    const users = json.users || [];
                    if (!users.length) {
                        content.innerHTML = '<div class="text-center text-slate-500">No users found.</div>';
                        return;
                    }
                    // Build a simple table
                    const rows = users.map(u => `
                        <div class="p-3 border-b border-slate-100 flex items-center justify-between">
                            <div>
                                <div class="font-medium">${escapeHtml(u.first_name || '')} ${escapeHtml(u.last_name || '')}</div>
                                <div class="text-xs text-slate-500">${escapeHtml(u.email || '')}</div>
                            </div>
                            <div class="text-xs text-slate-400">Joined: ${escapeHtml(u.created_at || '')}</div>
                        </div>
                    `).join('');
                    content.innerHTML = `<div class="divide-y divide-slate-100">${rows}</div>`;
                } catch (err) {
                    console.error('User list fetch error', err);
                    content.innerHTML = '<div class="text-red-600">Error loading users. See console for details.</div>';
                }
            }

            function closeUserList() {
                modal.classList.add('hidden');
                modal.classList.remove('flex');
                document.body.style.overflow = '';
            }

            btn.addEventListener('click', openUserList);
            overlay.addEventListener('click', closeUserList);
            closeBtn.addEventListener('click', closeUserList);

            // Escape closes
            document.addEventListener('keydown', function(e){ if (e.key === 'Escape' && !modal.classList.contains('hidden')) closeUserList(); });

            // Small helper to escape HTML
            function escapeHtml(str){ return String(str||'').replace(/[&"'<>]/g, function(s){ return ({'&':'&amp;','"':'&quot;',"'":'&#39;','<':'&lt;','>':'&gt;'})[s]; }); }
        });

        // ===== Retract vote modal behavior =====
        document.addEventListener('DOMContentLoaded', function(){
            const retractBtn = document.getElementById('retract-vote-btn');
            const modal = document.getElementById('retract-modal');
            const overlay = document.getElementById('retract-overlay');
            const closeBtn = document.getElementById('retract-close');
            const cancelBtn = document.getElementById('retract-cancel');
            const confirmBtn = document.getElementById('retract-confirm');
            const messageEl = document.getElementById('retract-modal-message');
            const form = document.getElementById('retract-form');

            if (!retractBtn || !modal || !form) return;

            function openModal() {
                const selectedText = retractBtn.getAttribute('data-selected-text') || '';
                if (messageEl) {
                    const safeText = selectedText ? ` Are you sure you want to retract your vote for "${selectedText}"? This cannot be undone.` : ' Are you sure you want to retract your vote? This cannot be undone.';
                    messageEl.textContent = safeText;
                }
                modal.classList.remove('hidden');
                modal.classList.add('flex');
                document.body.style.overflow = 'hidden';
            }

            function closeModal() {
                modal.classList.add('hidden');
                modal.classList.remove('flex');
                document.body.style.overflow = '';
            }

            retractBtn.addEventListener('click', openModal);
            overlay && overlay.addEventListener('click', closeModal);
            closeBtn && closeBtn.addEventListener('click', closeModal);
            cancelBtn && cancelBtn.addEventListener('click', closeModal);

            confirmBtn && confirmBtn.addEventListener('click', function(){
                // Submit the hidden form to retract vote
                try { form.submit(); } catch (err) { console.error('Failed to submit retract form', err); }
            });
            // Escape closes
            document.addEventListener('keydown', function(e){ if (e.key === 'Escape' && modal && !modal.classList.contains('hidden')) closeModal(); });
        });
    </script>
    {# Chart removed #}
{% endblock %}
