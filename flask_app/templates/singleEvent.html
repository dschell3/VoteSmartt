{% extends "base.html" %}

{% block title %}{{ event.title if event else 'Event' }} - VoteSmart{% endblock %}

{% block extra_css %}
/* Single event page scoped styles */
.event-hero { background: linear-gradient(90deg,#0b3b7a 0%,#155ac2 100%); color: white; border-radius: 12px; padding: 28px; }
.event-card { background: white; border-radius: 12px; padding: 20px; box-shadow: 0 8px 30px rgba(2,6,23,0.06); }
.cta-primary { background: linear-gradient(90deg,#0b3b7a,#155ac2); color:white; padding:10px 16px; border-radius:8px; font-weight:600 }
.cta-ghost { border:1px solid rgba(11,18,32,0.12); padding:10px 14px; border-radius:8px }
.recommendation-item { transition:transform .15s ease, box-shadow .15s ease }
.recommendation-item:hover { transform:translateY(-4px); box-shadow:0 10px 30px rgba(2,6,23,0.06) }
.vote-stack { display:flex; flex-direction:column; gap:10px; }
.vote-option { display:flex; align-items:flex-start; gap:10px; padding:14px 16px; border:1px solid #e2e8f0; border-radius:10px; cursor:pointer; background:#fff; transition:border-color .15s ease, background-color .15s ease; }
.vote-option:hover { border-color:#cbd5e1; }
.vote-option--selected { background:#eef5ff; border-color:#b9d0ff; }
.winner-outline { outline:2px solid #22c55e; outline-offset:2px; border-color:#22c55e; }
.welcome-banner { margin:4px 0 22px; padding:2px 0; }
.welcome-banner h2 { font-size:1.55rem; font-weight:700; letter-spacing:.5px; color:#0b3b7a; }
@media (min-width: 640px){ .welcome-banner h2 { font-size:1.65rem; } }
@media (min-width: 1024px) { .event-grid { display:grid; grid-template-columns: 1fr 360px; gap:28px } }
{% endblock %}

{% block content %}
<main class="max-w-6xl mx-auto px-6 py-12">
    {# Silently consume flash messages without displaying them #}
    {% with messages = get_flashed_messages(with_categories=true) %}
        {# Messages consumed but not displayed - prevents carryover to other pages #}
    {% endwith %}
    
    {% if not event %}
    <div class="event-card text-center">
        <h2 class="text-2xl font-semibold">Event not found</h2>
        <p class="mt-3 text-slate-600">The event you're looking for doesn't exist or has been removed.</p>
        <div class="mt-6"><a href="/eventList" class="cta-ghost">Back to events</a></div>
    </div>
    {% else %}

    <!-- Welcome banner OUTSIDE hero, left above blue card -->
    <div class="welcome-banner">
        <h2>Welcome {{ first_name if first_name else 'User' }}</h2>
    </div>

    <!-- Hero simplified: title / description / status left; organizer & timer right -->
    <section class="event-hero mb-8">
        <div class="flex items-start justify-between gap-6 flex-col lg:flex-row">
            <div class="flex-1">
                <h1 class="text-3xl lg:text-4xl font-extrabold">{{ event.title }}</h1>
                <p class="mt-3 text-slate-100 max-w-2xl">{{ event.description }}</p>
                <div class="mt-4 text-sm font-semibold tracking-wide">
                    <span>Status: <span id="liveStatus" class="font-normal">&mdash;</span></span>
                </div>
            </div>

            <div class="flex flex-col items-end gap-2 lg:mt-0">
                <div class="text-sm">Organized by</div>
                <div class="text-white font-semibold">{{ event.creator_full_name if event.creator_full_name else 'Unknown User' }}</div>
                <div id="timerLarge" class="text-indigo-200 font-medium mt-2">&mdash;</div>
            </div>
        </div>
    </section>

    <div class="event-grid">
        <!-- Main content -->
        <section>
            <div class="event-card">
                <h2 class="text-xl font-semibold">About this event</h2>
                <div class="mt-6">
                    <h3 class="text-sm text-slate-500 font-semibold">Details</h3>
                    <ul class="mt-3 space-y-3 text-sm text-slate-600">
                        <li><strong>Start:</strong> <span id="detailStart">&mdash;</span></li>
                        <li><strong>End:</strong> <span id="detailEnd">&mdash;</span></li>
                        <li><strong>Status:</strong> <span id="detailStatus">&mdash;</span></li>
                        <li><strong>Created at:</strong> {{ event.created_at or '—' }}</li>
                    </ul>
                </div>

            </div>

            {# Removed separate Full description block per new layout #}

            <!-- Ballot / Results -->
            <div class="mt-6 event-card" id="ballot">
                {% if is_open %}
                    <h3 class="text-lg font-semibold mb-4">Have a Pick</h3>
                    
                    {# NEW: Check if user is the event creator #}
                    {% if is_event_creator %}
                        {# Show disabled voting interface with explanation for event creators #}
                        <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-4 mb-4">
                            <div class="flex items-start gap-3">
                                <svg class="w-5 h-5 text-yellow-600 flex-shrink-0 mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
                                </svg>
                                <div>
                                    <p class="font-medium text-yellow-800">Event creators cannot vote</p>
                                    <p class="text-sm text-yellow-700 mt-1">As the creator of this event, you cannot participate in voting to maintain integrity and impartiality.</p>
                                </div>
                            </div>
                        </div>
                        
                        {% if not options %}
                            <div class="text-sm text-slate-500">No options available for voting.</div>
                        {% else %}
                            {# Show voting options in disabled state #}
                            <div class="space-y-2 opacity-60 pointer-events-none">
                                {% for o in options %}
                                <label class="flex items-start gap-3 p-3 rounded-lg border border-slate-200 bg-slate-50 cursor-not-allowed">
                                    <input type="radio" class="mt-1" name="option_id_disabled" value="{{ o.option_id }}" disabled />
                                    <div>
                                        <div class="font-medium text-slate-600">{{ o.option_text }}</div>
                                    </div>
                                </label>
                                {% endfor %}
                            </div>
                            <div class="mt-3">
                                <button type="button" class="cta-primary opacity-50 cursor-not-allowed" disabled>
                                    Submit Vote (Disabled)
                                </button>
                            </div>
                        {% endif %}
                    
                    {% else %}
                        {# Normal voting interface for non-creators #}
                        {% if not options %}
                            <div class="text-sm text-slate-500">No options available for voting.</div>
                        {% else %}
                            <form action="/vote/cast" method="post" class="space-y-3">
                                <input type="hidden" name="event_id" value="{{ event.event_id }}" />
                                <div class="vote-stack">
                                    {% for o in options %}
                                    <label class="vote-option {{ 'vote-option--selected' if selected_option_id==o.option_id else '' }}">
                                        <input type="radio" class="mt-1" name="option_id" value="{{ o.option_id }}" {{ 'checked' if selected_option_id==o.option_id }} />
                                        <div class="font-medium text-slate-800">{{ o.option_text }}</div>
                                    </label>
                                    {% endfor %}
                                </div>
                                <div class="flex items-center gap-3 pt-2">
                                    <button type="submit" class="cta-primary">{{ 'Update Vote' if selected_option_id else 'Submit Vote' }}</button>
                                    {% if selected_option_id %}
                                    <!-- Avoid nested forms: use HTML5 formaction to post to delete endpoint -->
                                    <button type="submit"
                                            class="cta-ghost"
                                            formmethod="post"
                                            formaction="/vote/delete"
                                            onclick="return confirm('Retract your vote?');">
                                        Retract Vote
                                    </button>
                                    {% endif %}
                                </div>
                                {% if selected_option_id %}
                                <div class="text-xs text-slate-500">You have voted already. You can update or retract while the event remains open.</div>
                                {% endif %}
                            </form>
                        {% endif %}
                    {% endif %}
                {% else %}
                    <h3 id="resultsHeading" class="text-lg font-semibold mb-4">Results</h3>
                    <div role="region" aria-labelledby="resultsHeading">
                        {% if not tallies %}
                            <div class="text-sm text-slate-500">No votes yet.</div>
                        {% else %}
                            <div class="vote-stack" role="list">
                                {% for t in tallies %}
                                <div class="vote-option {{ 'winner-outline' if winner_option_ids and t.option_id in winner_option_ids }}" role="listitem">
                                    <div class="flex justify-between w-full">
                                        <div>
                                            <div class="font-medium text-slate-800">{{ t.option_text }}</div>
                                            <div class="text-xs text-slate-500 mt-1">{{ t.votes }} vote{{ 's' if t.votes != 1 }}</div>
                                        </div>
                                        <div class="text-xl font-bold text-indigo-600">{{ t.votes }}</div>
                                    </div>
                                </div>
                                {% endfor %}
                            </div>
                        {% endif %}
                    </div>
                {% endif %}
            </div>
        </section>

        <!-- Sidebar: info/support + recommendations -->
        <aside>
            <div class="event-card mb-6">
                <h3 class="text-lg font-semibold mb-3">Info & Support</h3>
                <div class="flex flex-col gap-3">
                    <a href="/contact" class="cta-ghost text-center">Contact Us</a>
                    <a href="#ballot" class="cta-ghost text-center">Voting Information</a>
                    {% if is_event_creator %}
                    <button id="user-list-btn" class="cta-ghost text-center">User List</button>
                    {% endif %}
                </div>
            </div>
            <div class="event-card">
                <h4 class="text-lg font-semibold">You might also like</h4>
                <div class="mt-3 space-y-3">
                    {% if recommendations %}
                        {% for r in recommendations %}
                        <a href="/event/{{ r.event_id }}" class="recommendation-item block p-3 rounded-lg border border-slate-100">
                            <div class="flex items-start justify-between gap-3">
                                <div class="flex-1">
                                    <div class="text-sm font-semibold text-slate-900">{{ r.title }}</div>
                                    <div class="text-xs text-slate-500 mt-1">{{ r.description[:80] }}{% if r.description|length > 80 %}...{% endif %}</div>
                                </div>
                                <div class="shrink-0 text-xs text-slate-400">{{ r.computed_status or r.status or '—' }}</div>
                            </div>
                        </a>
                        {% endfor %}
                    {% else %}
                        <div class="text-sm text-slate-500">No recommendations</div>
                    {% endif %}
                </div>
            </div>
        </aside>
    </div>

    {% endif %}
</main>
<!-- User List Modal -->
<div id="user-list-modal" class="fixed inset-0 hidden items-center justify-center z-50">
    <div class="absolute inset-0 bg-black/50" id="user-list-overlay"></div>
    <div class="relative bg-white rounded-lg shadow-2xl w-full max-w-2xl mx-4">
        <div class="p-6">
            <div class="flex items-center justify-between">
                <h3 class="text-lg font-semibold">All Users</h3>
                <button id="user-list-close" class="text-sm text-slate-600">Close</button>
            </div>
            <div id="user-list-content" class="mt-4 max-h-96 overflow-auto text-sm text-slate-700">
                <div class="text-center text-slate-400">Loading...</div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
    <!-- Reuse Day.js as used in other templates -->
    <script src="https://cdn.jsdelivr.net/npm/dayjs@1.11.9/dayjs.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/dayjs@1.11.9/plugin/customParseFormat.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/dayjs@1.11.9/plugin/relativeTime.min.js"></script>
    <script src="{{ url_for('static', filename='js/time-utils.js') }}"></script>
    <script src="{{ url_for('static', filename='js/vote-interactions.js') }}"></script>
    <script>
        dayjs.extend(dayjs_plugin_customParseFormat);
        dayjs.extend(dayjs_plugin_relativeTime);

        function tryParse(raw) { return (window.TimeUtils && TimeUtils.tryParse) ? TimeUtils.tryParse(raw) : null; }

        function formatDisplay(elId, raw) {
            const el = document.getElementById(elId);
            if (!el) return;
            el.textContent = (window.TimeUtils && TimeUtils.formatSingle) ? TimeUtils.formatSingle(raw) : '—';
        }

        function computeStatus(startRaw,endRaw) { return (window.TimeUtils && TimeUtils.computeStatus) ? TimeUtils.computeStatus(startRaw,endRaw) : 'Unknown'; }

        document.addEventListener('DOMContentLoaded', function(){
            const startRaw = '{{ event.start_time or "" }}';
            const endRaw = '{{ event.end_time or "" }}';
            formatDisplay('detailStart', startRaw);
            formatDisplay('detailEnd', endRaw);

            const status = computeStatus(startRaw,endRaw);
            const statusEl = document.getElementById('liveStatus');
            const detailStatus = document.getElementById('detailStatus');
            if (statusEl) statusEl.textContent = status;
            if (detailStatus) detailStatus.textContent = status;

            // Start a large timer display
            const timerEl = document.getElementById('timerLarge');
            function tick() {
                const now = dayjs();
                const start = tryParse(startRaw);
                if (!start) { if (timerEl) timerEl.textContent = '—'; return; }
                const diff = start.diff(now);
                if (diff > 0) {
                    timerEl.textContent = 'Starts in ' + humanDuration(diff);
                } else {
                    timerEl.textContent = 'Started ' + humanDuration(-diff) + ' ago';
                }
            }

            function humanDuration(ms) { return (window.TimeUtils && TimeUtils.humanDuration) ? TimeUtils.humanDuration(ms) : `${Math.floor(ms/1000)}s`; }

            tick();
            setInterval(tick,1000);

            // Set results bar widths when present
            // Removed pie-chart + bar width logic per simplified spec
        });
        // ===== User List modal logic (creator only) =====
        document.addEventListener('DOMContentLoaded', function(){
            const btn = document.getElementById('user-list-btn');
            const modal = document.getElementById('user-list-modal');
            const overlay = document.getElementById('user-list-overlay');
            const closeBtn = document.getElementById('user-list-close');
            const content = document.getElementById('user-list-content');
            if (!btn || !modal) return; // not creator or no modal

            async function openUserList() {
                modal.classList.remove('hidden');
                modal.classList.add('flex');
                document.body.style.overflow = 'hidden';
                content.innerHTML = '<div class="text-center text-slate-400">Loading...</div>';
                try {
                    const resp = await fetch('/users/list', { credentials: 'same-origin' });
                    if (!resp.ok) {
                        content.innerHTML = `<div class="text-red-600">Failed to load users (status ${resp.status})</div>`;
                        return;
                    }
                    const json = await resp.json();
                    if (!json.ok) {
                        content.innerHTML = `<div class="text-red-600">${json.error || 'Failed to load users'}</div>`;
                        return;
                    }
                    const users = json.users || [];
                    if (!users.length) {
                        content.innerHTML = '<div class="text-center text-slate-500">No users found.</div>';
                        return;
                    }
                    // Build a simple table
                    const rows = users.map(u => `
                        <div class="p-3 border-b border-slate-100 flex items-center justify-between">
                            <div>
                                <div class="font-medium">${escapeHtml(u.first_name || '')} ${escapeHtml(u.last_name || '')}</div>
                                <div class="text-xs text-slate-500">${escapeHtml(u.email || '')}</div>
                            </div>
                            <div class="text-xs text-slate-400">Joined: ${escapeHtml(u.created_at || '')}</div>
                        </div>
                    `).join('');
                    content.innerHTML = `<div class="divide-y divide-slate-100">${rows}</div>`;
                } catch (err) {
                    console.error('User list fetch error', err);
                    content.innerHTML = '<div class="text-red-600">Error loading users. See console for details.</div>';
                }
            }

            function closeUserList() {
                modal.classList.add('hidden');
                modal.classList.remove('flex');
                document.body.style.overflow = '';
            }

            btn.addEventListener('click', openUserList);
            overlay.addEventListener('click', closeUserList);
            closeBtn.addEventListener('click', closeUserList);

            // Escape closes
            document.addEventListener('keydown', function(e){ if (e.key === 'Escape' && !modal.classList.contains('hidden')) closeUserList(); });

            // Small helper to escape HTML
            function escapeHtml(str){ return String(str||'').replace(/[&"'<>]/g, function(s){ return ({'&':'&amp;','"':'&quot;',"'":'&#39;','<':'&lt;','>':'&gt;'})[s]; }); }
        });
    </script>
    {# Chart removed #}
{% endblock %}
