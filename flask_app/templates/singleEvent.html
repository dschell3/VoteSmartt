{% extends "base.html" %}

{% block title %}{{ event.title if event else 'Event' }} - VoteSmart{% endblock %}

{% block extra_css %}
/* Small scoped styles to make single event look professional */
.event-hero { background: linear-gradient(90deg,#0b3b7a 0%,#155ac2 100%); color: white; border-radius: 12px; padding: 28px; }
.event-card { background: white; border-radius: 12px; padding: 20px; box-shadow: 0 8px 30px rgba(2,6,23,0.06); }
.meta-pill { display:inline-flex; align-items:center; gap:8px; padding:8px 12px; border-radius:9999px; background:#f1f5f9; font-weight:600; color:#0b1220 }
.cta-primary { background: linear-gradient(90deg,#0b3b7a,#155ac2); color:white; padding:10px 16px; border-radius:8px; font-weight:600 }
.cta-ghost { border:1px solid rgba(11,18,32,0.06); padding:10px 14px; border-radius:8px }
.recommendation-item { transition:transform .15s ease, box-shadow .15s ease }
.recommendation-item:hover { transform:translateY(-4px); box-shadow:0 10px 30px rgba(2,6,23,0.06) }

@media (min-width: 1024px) {
    .event-grid { display:grid; grid-template-columns: 1fr 360px; gap:28px }
}

{% endblock %}

{% block content %}
<main class="max-w-6xl mx-auto px-6 py-12">
    {% if not event %}
    <div class="event-card text-center">
        <h2 class="text-2xl font-semibold">Event not found</h2>
        <p class="mt-3 text-slate-600">The event you're looking for doesn't exist or has been removed.</p>
        <div class="mt-6"><a href="/eventList" class="cta-ghost">Back to events</a></div>
    </div>
    {% else %}

    <!-- Hero -->
    <section class="event-hero mb-8">
        <div class="flex items-start justify-between gap-6 flex-col lg:flex-row">
            <div class="flex-1">
                <h1 class="text-3xl lg:text-4xl font-extrabold">{{ event.title }}</h1>
                <p class="mt-3 text-slate-100 max-w-2xl">{{ event.description }}</p>

                <div class="mt-4 flex flex-wrap items-center gap-3">
                    <span class="meta-pill">
                        <svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4 text-indigo-600" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 8v4l3 3"></path></svg>
                        <span id="startDisplay">&mdash;</span>
                    </span>

                    <span class="meta-pill">
                        <svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4 text-slate-700" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 8h18"></path></svg>
                        <span id="endDisplay">&mdash;</span>
                    </span>

                    <span id="liveStatus" class="meta-pill" style="background:rgba(255,255,255,0.12); color:#fff">&mdash;</span>
                </div>
            </div>

            <div class="mt-6 lg:mt-0">
                <div class="event-card text-right">
                    <div class="text-sm text-slate-500">Organized by</div>
                    <div class="mt-1 font-semibold">User #{{ event.created_by }}</div>
                    <div class="mt-4">
                        <div id="timerLarge" class="text-indigo-600 font-medium">&mdash;</div>
                    </div>
                    <div class="mt-6 flex gap-3 justify-end">
                        <a href="/eventList" class="cta-ghost">Back</a>
                        <a href="#" class="cta-primary">Register</a>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <div class="event-grid">
        <!-- Main content -->
        <section>
            <div class="event-card">
                <h2 class="text-xl font-semibold">About this event</h2>
                <div class="mt-4 text-slate-700 leading-relaxed">
                    {{ event.description }}
                </div>

                <div class="mt-6">
                    <h3 class="text-sm text-slate-500 font-semibold">Details</h3>
                    <ul class="mt-3 space-y-3 text-sm text-slate-600">
                        <li><strong>Start:</strong> <span id="detailStart">&mdash;</span></li>
                        <li><strong>End:</strong> <span id="detailEnd">&mdash;</span></li>
                        <li><strong>Status:</strong> <span id="detailStatus">&mdash;</span></li>
                        <li><strong>Created at:</strong> {{ event.created_at or '—' }}</li>
                    </ul>
                </div>

            </div>

            <!-- Description / long copy area could include attachments, media etc. -->
            <div class="mt-6 event-card">
                <h3 class="text-lg font-semibold">Full description</h3>
                <div class="mt-3 text-slate-700 leading-relaxed">
                    {{ event.description }}
                </div>
            </div>

            <!-- Ballot / Results -->
            <div class="mt-6 event-card" id="ballot">
                {% if is_open %}
                    <h3 class="text-lg font-semibold mb-4">Cast your vote</h3>
                    {% if not options %}
                        <div class="text-sm text-slate-500">No options available for voting.</div>
                    {% else %}
                        <form action="/vote/cast" method="post" class="space-y-3">
                            <input type="hidden" name="event_id" value="{{ event.event_id }}" />
                            <div class="space-y-2">
                                {% for o in options %}
                                <label class="flex items-start gap-3 p-3 rounded-lg border cursor-pointer {{ 'bg-indigo-50 border-indigo-200' if selected_option_id==o.option_id else 'border-slate-200 hover:border-slate-300' }}">
                                    <input type="radio" class="mt-1" name="option_id" value="{{ o.option_id }}" {{ 'checked' if selected_option_id==o.option_id }} />
                                    <div>
                                        <div class="font-medium text-slate-800">{{ o.option_text }}</div>
                                    </div>
                                </label>
                                {% endfor %}
                            </div>
                            <div class="flex items-center gap-3 pt-2">
                                <button type="submit" class="cta-primary">{{ 'Update Vote' if selected_option_id else 'Submit Vote' }}</button>
                                {% if selected_option_id %}
                                <!-- Avoid nested forms: use HTML5 formaction to post to delete endpoint -->
                                <button type="submit"
                                        class="cta-ghost"
                                        formmethod="post"
                                        formaction="/vote/delete"
                                        onclick="return confirm('Retract your vote?');">
                                    Retract Vote
                                </button>
                                {% endif %}
                            </div>
                            {% if selected_option_id %}
                            <div class="text-xs text-slate-500">You have voted already. You can update or retract while the event remains open.</div>
                            {% endif %}
                        </form>
                    {% endif %}
                {% else %}
                    <h3 class="text-lg font-semibold mb-4">Results</h3>
                    {% if not tallies %}
                        <div class="text-sm text-slate-500">No votes yet.</div>
                    {% else %}
                        <div class="space-y-3" id="results">
                            {% set max_votes = (tallies|map(attribute='votes')|list|max) if tallies else 0 %}
                            {% for row in tallies %}
                            <div>
                                <div class="flex justify-between text-sm mb-1">
                                    <div class="font-medium text-slate-800">{{ row.option_text }}</div>
                                    <div class="text-slate-500">{{ row.votes }}</div>
                                </div>
                                {% set pct = (100.0*row.votes/max_votes) if max_votes else 0 %}
                                <div class="h-2 bg-slate-100 rounded">
                                    <div class="h-2 bg-indigo-500 rounded result-bar" data-pct="{{ pct|round(0, 'floor') }}"></div>
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                    {% endif %}
                {% endif %}
            </div>
        </section>

        <!-- Sidebar: recommendations & quick actions -->
        <aside>
            <div class="event-card">
                <h3 class="text-lg font-semibold">Quick actions</h3>
                <div class="mt-3 flex flex-col gap-3">
                    {% if is_open %}
                        <a href="#ballot" class="cta-primary text-center">Vote now</a>
                    {% else %}
                        <a href="#ballot" class="cta-ghost text-center">View results</a>
                    {% endif %}
                    <a href="#" class="cta-ghost text-center">Share</a>
                    <a href="#" class="cta-ghost text-center">Report</a>
                </div>
            </div>

            <div class="mt-6 event-card">
                <h4 class="text-lg font-semibold">You might also like</h4>
                <div class="mt-3 space-y-3">
                    {% if recommendations %}
                        {% for r in recommendations %}
                        <a href="/event/{{ r.event_id }}" class="recommendation-item block p-3 rounded-lg border border-slate-100">
                            <div class="flex items-start justify-between gap-3">
                                <div class="flex-1">
                                    <div class="text-sm font-semibold text-slate-900">{{ r.title }}</div>
                                    <div class="text-xs text-slate-500 mt-1">{{ r.description[:80] }}{% if r.description|length > 80 %}...{% endif %}</div>
                                </div>
                                <div class="shrink-0 text-xs text-slate-400">{{ r.status or '—' }}</div>
                            </div>
                        </a>
                        {% endfor %}
                    {% else %}
                        <div class="text-sm text-slate-500">No recommendations</div>
                    {% endif %}
                </div>
            </div>
        </aside>
    </div>

    {% endif %}
</main>
{% endblock %}

{% block extra_js %}
    <!-- Reuse Day.js as used in other templates -->
    <script src="https://cdn.jsdelivr.net/npm/dayjs@1.11.9/dayjs.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/dayjs@1.11.9/plugin/customParseFormat.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/dayjs@1.11.9/plugin/relativeTime.min.js"></script>
    <script src="{{ url_for('static', filename='js/time-utils.js') }}"></script>
    <script>
        dayjs.extend(dayjs_plugin_customParseFormat);
        dayjs.extend(dayjs_plugin_relativeTime);

        function tryParse(raw) { return (window.TimeUtils && TimeUtils.tryParse) ? TimeUtils.tryParse(raw) : null; }

        function formatDisplay(elId, raw) {
            const el = document.getElementById(elId);
            if (!el) return;
            el.textContent = (window.TimeUtils && TimeUtils.formatSingle) ? TimeUtils.formatSingle(raw) : '—';
        }

        function computeStatus(startRaw,endRaw) { return (window.TimeUtils && TimeUtils.computeStatus) ? TimeUtils.computeStatus(startRaw,endRaw) : 'Unknown'; }

        document.addEventListener('DOMContentLoaded', function(){
            const startRaw = '{{ event.start_time or "" }}';
            const endRaw = '{{ event.end_time or "" }}';
            formatDisplay('startDisplay', startRaw);
            formatDisplay('endDisplay', endRaw);
            formatDisplay('detailStart', startRaw);
            formatDisplay('detailEnd', endRaw);

            const status = computeStatus(startRaw,endRaw);
            const statusEl = document.getElementById('liveStatus');
            const detailStatus = document.getElementById('detailStatus');
            if (statusEl) statusEl.textContent = status;
            if (detailStatus) detailStatus.textContent = status;

            // Start a large timer display
            const timerEl = document.getElementById('timerLarge');
            function tick() {
                const now = dayjs();
                const start = tryParse(startRaw);
                if (!start) { if (timerEl) timerEl.textContent = '—'; return; }
                const diff = start.diff(now);
                if (diff > 0) {
                    timerEl.textContent = 'Starts in ' + humanDuration(diff);
                } else {
                    timerEl.textContent = 'Started ' + humanDuration(-diff) + ' ago';
                }
            }

            function humanDuration(ms) { return (window.TimeUtils && TimeUtils.humanDuration) ? TimeUtils.humanDuration(ms) : `${Math.floor(ms/1000)}s`; }

            tick();
            setInterval(tick,1000);

            // Set results bar widths when present
            document.querySelectorAll('.result-bar').forEach(function(el){
                var pct = parseFloat(el.getAttribute('data-pct') || '0');
                if (!isNaN(pct)) { el.style.width = pct + '%'; }
            });
        });
    </script>
{% endblock %}
